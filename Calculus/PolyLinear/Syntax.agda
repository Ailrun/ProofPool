module Calculus.PolyLinear.Syntax where

open import Data.Empty
open import Data.List
open import Data.Nat
open import Data.Product
open import Data.Unit hiding (_â‰Ÿ_)
open import Relation.Nullary

-- Kind
data ğ•‚ : Set where
  Tyâ‚— : ğ•‚

infixr 30 tvarâ‚—
infixr 30 !â‚—_
infixr 29 _âŠ¸â‚—_
infixr 28 âˆ€â‚—_âˆ™_

-- Type
data ğ•‹ : Set where
  tvarâ‚— : â„• â†’ ğ•‹
  _âŠ¸â‚—_  : ğ•‹ â†’ ğ•‹ â†’ ğ•‹
  !â‚—_   : ğ•‹ â†’ ğ•‹
  âˆ€â‚—_âˆ™_ : ğ•‚ â†’ ğ•‹ â†’ ğ•‹

infixr 30 varâ‚—
infixr 30 bangâ‚—
infixl 29 _$â‚—âˆ˜_
infixl 29 _$$â‚—âˆ™_
infixr 28 let-bangâ‚—_inâ‚—_
infixr 27 Î»â‚—_âˆ˜_
infixr 27 Î›â‚—_âˆ™_

-- Term
data ğ•„ : Set where
  varâ‚—           : â„• â†’ ğ•„
  Î»â‚—_âˆ˜_          : ğ•‹ â†’ ğ•„ â†’ ğ•„
  _$â‚—âˆ˜_          : ğ•„ â†’ ğ•„ â†’ ğ•„
  bangâ‚—          : ğ•„ â†’ ğ•„
  let-bangâ‚—_inâ‚—_ : ğ•„ â†’ ğ•„ â†’ ğ•„
  Î›â‚—_âˆ™_          : ğ•‚ â†’ ğ•„ â†’ ğ•„
  _$$â‚—âˆ™_         : ğ•„ â†’ ğ•‹ â†’ ğ•„

-- Usage
data ğ•Œ : Set where
  0/1â‚— : ğ•Œ
  1/1â‚— : ğ•Œ
  âˆâ‚—   : ğ•Œ

infix 6 _/ğ•‚
infix 6 _/ğ•‹

data â„‚ğ”¼ : Set where
  _/ğ•‚ : ğ•‚ â†’ â„‚ğ”¼
  _/ğ•‹ : ğ•‹ Ã— ğ•Œ â†’ â„‚ğ”¼

data â„‚ğ”¼â» : Set where
  _/ğ•‚ : ğ•‚ â†’ â„‚ğ”¼â»
  _/ğ•‹ : ğ•‹ â†’ â„‚ğ”¼â»

-- Context
â„‚  = List â„‚ğ”¼
-- Context Skeleton
â„‚â» = List â„‚ğ”¼â»

data ğ•Šğ”¼ : Set where
  _/ğ•‹ : ğ•‹ â†’ ğ•Šğ”¼
  _/ğ•„ : ğ•„ â†’ ğ•Šğ”¼

-- Substitution
ğ•Š = List ğ•Šğ”¼

variable
  x xâ€² xâ€³ xâ€´ xâ‚€ xâ‚ xâ‚‚ xâ‚ƒ : â„•
  y yâ€² yâ€³ yâ€´ yâ‚€ yâ‚ yâ‚‚ yâ‚ƒ : â„•
  z zâ€² zâ€³ zâ€´ zâ‚€ zâ‚ zâ‚‚ zâ‚ƒ : â„•

  K Kâ€² Kâ€³ Kâ€´ Kâ‚€ Kâ‚ Kâ‚‚ Kâ‚ƒ : ğ•‚

  T Tâ€² Tâ€³ Tâ€´ Tâ‚€ Tâ‚ Tâ‚‚ Tâ‚ƒ : ğ•‹
  U Uâ€² Uâ€³ Uâ€´ Uâ‚€ Uâ‚ Uâ‚‚ Uâ‚ƒ : ğ•‹
  V Vâ€² Vâ€³ Vâ€´ Vâ‚€ Vâ‚ Vâ‚‚ Vâ‚ƒ : ğ•‹

  M Mâ€² Mâ€³ Mâ€´ Mâ‚€ Mâ‚ Mâ‚‚ Mâ‚ƒ : ğ•„
  N Nâ€² Nâ€³ Nâ€´ Nâ‚€ Nâ‚ Nâ‚‚ Nâ‚ƒ : ğ•„
  O Oâ€² Oâ€³ Oâ€´ Oâ‚€ Oâ‚ Oâ‚‚ Oâ‚ƒ : ğ•„
  P Pâ€² Pâ€³ Pâ€´ Pâ‚€ Pâ‚ Pâ‚‚ Pâ‚ƒ : ğ•„

  u uâ€² uâ€³ uâ€´ uâ‚€ uâ‚ uâ‚‚ uâ‚ƒ : ğ•Œ

  Î“ Î“â€² Î“â€³ Î“â€´ Î“â‚€ Î“â‚ Î“â‚‚ Î“â‚ƒ : â„‚
  Î” Î”â€² Î”â€³ Î”â€´ Î”â‚€ Î”â‚ Î”â‚‚ Î”â‚ƒ : â„‚
  Î¨ Î¨â€² Î¨â€³ Î¨â€´ Î¨â‚€ Î¨â‚ Î¨â‚‚ Î¨â‚ƒ : â„‚

  E Eâ€² Eâ€³ Eâ€´ Eâ‚€ Eâ‚ Eâ‚‚ Eâ‚ƒ : â„‚ğ”¼

  Î“â» Î“â»â€² Î“â»â€³ Î“â»â€´ Î“â»â‚€ Î“â»â‚ Î“â»â‚‚ Î“â»â‚ƒ : â„‚â»
  Î”â» Î”â»â€² Î”â»â€³ Î”â»â€´ Î”â»â‚€ Î”â»â‚ Î”â»â‚‚ Î”â»â‚ƒ : â„‚â»
  Î¨â» Î¨â»â€² Î¨â»â€³ Î¨â»â€´ Î¨â»â‚€ Î¨â»â‚ Î¨â»â‚‚ Î¨â»â‚ƒ : â„‚â»

  Eâ» Eâ»â€² Eâ»â€³ Eâ»â€´ Eâ»â‚€ Eâ»â‚ Eâ»â‚‚ Eâ»â‚ƒ : â„‚ğ”¼â»

  s sâ€² sâ€³ sâ€´ sâ‚€ sâ‚ sâ‚‚ sâ‚ƒ : ğ•Šğ”¼

  Ïƒ Ïƒâ€² Ïƒâ€³ Ïƒâ€´ Ïƒâ‚€ Ïƒâ‚ Ïƒâ‚‚ Ïƒâ‚ƒ : ğ•Š
  Ï„ Ï„â€² Ï„â€³ Ï„â€´ Ï„â‚€ Ï„â‚ Ï„â‚‚ Ï„â‚ƒ : ğ•Š

pattern âŠ¤â‚— = âˆ€â‚— Tyâ‚— âˆ™ tvarâ‚— 0 âŠ¸â‚— tvarâ‚— 0
pattern ttâ‚— = Î›â‚— Tyâ‚— âˆ™ Î»â‚— tvarâ‚— 0 âˆ˜ varâ‚— 0

useableğ•Œ : ğ•Œ â†’ Set
useableğ•Œ 0/1â‚— = âŠ¤
useableğ•Œ 1/1â‚— = âŠ¥
useableğ•Œ âˆâ‚—   = âŠ¤

incğ•Œ : (u : ğ•Œ) â†’ .(useableğ•Œ u) â†’ ğ•Œ
incğ•Œ 0/1â‚— _ = 1/1â‚—
incğ•Œ âˆâ‚—   _ = âˆâ‚—

extractâ„‚â» : â„‚ â†’ â„‚â»
extractâ„‚â» []             = []
extractâ„‚â» (K       /ğ•‚ âˆ· Î“) = K /ğ•‚ âˆ· extractâ„‚â» Î“
extractâ„‚â» ((T , _) /ğ•‹ âˆ· Î“) = T /ğ•‹ âˆ· extractâ„‚â» Î“

record HasLength (S : Set) : Set where
  inductive
  field
    len : S â†’ â„•

open HasLength {{...}} public

{-# DISPLAY HasLength.len s = len s #-}

instance
  HasLengthâ„‚ : HasLength â„‚
  len {{HasLengthâ„‚}} = length

  HasLengthâ„‚â» : HasLength â„‚â»
  len {{HasLengthâ„‚â»}} = length

  HasLengthğ•Š : HasLength ğ•Š
  len {{HasLengthğ•Š}} = length

_ğ•ŒÃ—ğ•Œ_ : ğ•Œ â†’ ğ•Œ â†’ ğ•Œ
u    ğ•ŒÃ—ğ•Œ 0/1â‚— = 0/1â‚—
u    ğ•ŒÃ—ğ•Œ 1/1â‚— = u
0/1â‚— ğ•ŒÃ—ğ•Œ âˆâ‚—   = 0/1â‚—
1/1â‚— ğ•ŒÃ—ğ•Œ âˆâ‚—   = âˆâ‚—
âˆâ‚—   ğ•ŒÃ—ğ•Œ âˆâ‚—   = âˆâ‚—

_â„‚Ã—ğ•Œ_ : â„‚ â†’ ğ•Œ â†’ â„‚
[]             â„‚Ã—ğ•Œ uâ€² = []
(K       /ğ•‚ âˆ· Î“) â„‚Ã—ğ•Œ uâ€² = K /ğ•‚ âˆ· (Î“ â„‚Ã—ğ•Œ uâ€²)
((T , u) /ğ•‹ âˆ· Î“) â„‚Ã—ğ•Œ uâ€² = (T , u ğ•ŒÃ—ğ•Œ uâ€²) /ğ•‹ âˆ· (Î“ â„‚Ã—ğ•Œ uâ€²)

infixr 30 wkâ„•âˆ£_â†‘_âˆ£_
infixr 30 wkğ•‚âˆ£_â†‘_âˆ£_
infixr 30 wkğ•‹âˆ£_â†‘_âˆ£_
infixr 30 wkâ„‚ğ”¼âˆ£_â†‘_âˆ£_
infixr 30 wkâ„‚ğ”¼â»âˆ£_â†‘_âˆ£_
infixr 30 wkâ„‚âˆ£_â†‘_âˆ£_
infixr 30 wkâ„‚â»âˆ£_â†‘_âˆ£_
infixr 30 wkğ•„âˆ£_â†‘_âˆ£_
infixr 30 wkğ•Šğ”¼âˆ£_â†‘_âˆ£_
infixr 30 wkğ•Šâˆ£_â†‘_âˆ£_

wkâ„•âˆ£_â†‘_âˆ£_ : â„• â†’ â„• â†’ â„• â†’ â„•
wkâ„•âˆ£ n â†‘ x âˆ£ y
  with y â‰¥? x
...  | no  _ = y
...  | yes _ = n + y

wkğ•‚âˆ£_â†‘_âˆ£_ : â„• â†’ â„• â†’ ğ•‚ â†’ ğ•‚
wkğ•‚âˆ£ n â†‘ x âˆ£ Tyâ‚— = Tyâ‚—

wkğ•‹âˆ£_â†‘_âˆ£_ : â„• â†’ â„• â†’ ğ•‹ â†’ ğ•‹
wkğ•‹âˆ£ n â†‘ x âˆ£ tvarâ‚— y    = tvarâ‚— (wkâ„•âˆ£ n â†‘ x âˆ£ y)
wkğ•‹âˆ£ n â†‘ x âˆ£ (T âŠ¸â‚— U)   = wkğ•‹âˆ£ n â†‘ x âˆ£ T âŠ¸â‚— wkğ•‹âˆ£ n â†‘ x âˆ£ U
wkğ•‹âˆ£ n â†‘ x âˆ£ (!â‚— T)     = !â‚— (wkğ•‹âˆ£ n â†‘ x âˆ£ T)
wkğ•‹âˆ£ n â†‘ x âˆ£ (âˆ€â‚— K âˆ™ T) = âˆ€â‚— wkğ•‚âˆ£ n â†‘ x âˆ£ K âˆ™ wkğ•‹âˆ£ n â†‘ suc x âˆ£ T

wkâ„‚ğ”¼âˆ£_â†‘_âˆ£_ : â„• â†’ â„• â†’ â„‚ğ”¼ â†’ â„‚ğ”¼
wkâ„‚ğ”¼âˆ£ n â†‘ x âˆ£ (K /ğ•‚)       = wkğ•‚âˆ£ n â†‘ x âˆ£ K /ğ•‚
wkâ„‚ğ”¼âˆ£ n â†‘ x âˆ£ ((T , u) /ğ•‹) = (wkğ•‹âˆ£ n â†‘ x âˆ£ T , u) /ğ•‹

wkâ„‚ğ”¼â»âˆ£_â†‘_âˆ£_ : â„• â†’ â„• â†’ â„‚ğ”¼â» â†’ â„‚ğ”¼â»
wkâ„‚ğ”¼â»âˆ£ n â†‘ x âˆ£ (K /ğ•‚) = wkğ•‚âˆ£ n â†‘ x âˆ£ K /ğ•‚
wkâ„‚ğ”¼â»âˆ£ n â†‘ x âˆ£ (T /ğ•‹) = wkğ•‹âˆ£ n â†‘ x âˆ£ T /ğ•‹

wkâ„‚âˆ£_â†‘_âˆ£_ : â„• â†’ â„• â†’ â„‚ â†’ â„‚
wkâ„‚âˆ£ n â†‘ zero  âˆ£ Î“       = Î“
wkâ„‚âˆ£ n â†‘ suc x âˆ£ []      = []
wkâ„‚âˆ£ n â†‘ suc x âˆ£ (E âˆ· Î“) = wkâ„‚ğ”¼âˆ£ n â†‘ x âˆ£ E âˆ· wkâ„‚âˆ£ n â†‘ x âˆ£ Î“

wkâ„‚â»âˆ£_â†‘_âˆ£_ : â„• â†’ â„• â†’ â„‚â» â†’ â„‚â»
wkâ„‚â»âˆ£ n â†‘ zero  âˆ£ Î“       = Î“
wkâ„‚â»âˆ£ n â†‘ suc x âˆ£ []      = []
wkâ„‚â»âˆ£ n â†‘ suc x âˆ£ (E âˆ· Î“) = wkâ„‚ğ”¼â»âˆ£ n â†‘ x âˆ£ E âˆ· wkâ„‚â»âˆ£ n â†‘ x âˆ£ Î“

wkğ•„âˆ£_â†‘_âˆ£_ : â„• â†’ â„• â†’ ğ•„ â†’ ğ•„
wkğ•„âˆ£ n â†‘ x âˆ£ varâ‚— y              = varâ‚— (wkâ„•âˆ£ n â†‘ x âˆ£ y)
wkğ•„âˆ£ n â†‘ x âˆ£ (Î»â‚— T âˆ˜ M)          = Î»â‚— wkğ•‹âˆ£ n â†‘ x âˆ£ T âˆ˜ wkğ•„âˆ£ n â†‘ suc x âˆ£ M
wkğ•„âˆ£ n â†‘ x âˆ£ (M $â‚—âˆ˜ N)           = wkğ•„âˆ£ n â†‘ x âˆ£ M $â‚—âˆ˜ wkğ•„âˆ£ n â†‘ x âˆ£ N
wkğ•„âˆ£ n â†‘ x âˆ£ bangâ‚— M             = bangâ‚— (wkğ•„âˆ£ n â†‘ x âˆ£ M)
wkğ•„âˆ£ n â†‘ x âˆ£ (let-bangâ‚— M inâ‚— N) = let-bangâ‚— wkğ•„âˆ£ n â†‘ x âˆ£ M inâ‚— wkğ•„âˆ£ n â†‘ suc x âˆ£ N
wkğ•„âˆ£ n â†‘ x âˆ£ (Î›â‚— K âˆ™ M)          = Î›â‚— wkğ•‚âˆ£ n â†‘ x âˆ£ K âˆ™ wkğ•„âˆ£ n â†‘ suc x âˆ£ M
wkğ•„âˆ£ n â†‘ x âˆ£ (M $$â‚—âˆ™ T)          = wkğ•„âˆ£ n â†‘ x âˆ£ M $$â‚—âˆ™ wkğ•‹âˆ£ n â†‘ x âˆ£ T

wkğ•Šğ”¼âˆ£_â†‘_âˆ£_ : â„• â†’ â„• â†’ ğ•Šğ”¼ â†’ ğ•Šğ”¼
wkğ•Šğ”¼âˆ£ n â†‘ x âˆ£ (T /ğ•‹) = wkğ•‹âˆ£ n â†‘ x âˆ£ T /ğ•‹
wkğ•Šğ”¼âˆ£ n â†‘ x âˆ£ (M /ğ•„) = wkğ•„âˆ£ n â†‘ x âˆ£ M /ğ•„

wkğ•Šâˆ£_â†‘_âˆ£_ : â„• â†’ â„• â†’ ğ•Š â†’ ğ•Š
wkğ•Šâˆ£ n â†‘ x âˆ£ []      = []
wkğ•Šâˆ£ n â†‘ x âˆ£ (E âˆ· Î“) = wkğ•Šğ”¼âˆ£ n â†‘ x âˆ£ E âˆ· wkğ•Šâˆ£ n â†‘ x âˆ£ Î“

record Weakening (S : Set) : Set where
  inductive
  constructor mkWeakening
  infixr 30 wkâˆ£_â†‘_âˆ£_
  field
    wkâˆ£_â†‘_âˆ£_ : â„• â†’ â„• â†’ S â†’ S

open Weakening {{...}} public

{-# DISPLAY Weakening.wkâˆ£_â†‘_âˆ£_ n m s = wkâˆ£ n â†‘ m âˆ£ s #-}

instance
  Weakeningâ„• : Weakening â„•
  wkâˆ£_â†‘_âˆ£_ {{Weakeningâ„•}} = wkâ„•âˆ£_â†‘_âˆ£_

  Weakeningğ•‚ : Weakening ğ•‚
  wkâˆ£_â†‘_âˆ£_ {{Weakeningğ•‚}} = wkğ•‚âˆ£_â†‘_âˆ£_

  Weakeningğ•‹ : Weakening ğ•‹
  wkâˆ£_â†‘_âˆ£_ {{Weakeningğ•‹}} = wkğ•‹âˆ£_â†‘_âˆ£_

  Weakeningâ„‚ğ”¼ : Weakening â„‚ğ”¼
  wkâˆ£_â†‘_âˆ£_ {{Weakeningâ„‚ğ”¼}} = wkâ„‚ğ”¼âˆ£_â†‘_âˆ£_

  Weakeningâ„‚ğ”¼â» : Weakening â„‚ğ”¼â»
  wkâˆ£_â†‘_âˆ£_ {{Weakeningâ„‚ğ”¼â»}} = wkâ„‚ğ”¼â»âˆ£_â†‘_âˆ£_

  Weakeningâ„‚ : Weakening â„‚
  wkâˆ£_â†‘_âˆ£_ {{Weakeningâ„‚}} = wkâ„‚âˆ£_â†‘_âˆ£_

  Weakeningâ„‚â» : Weakening â„‚â»
  wkâˆ£_â†‘_âˆ£_ {{Weakeningâ„‚â»}} = wkâ„‚â»âˆ£_â†‘_âˆ£_

  Weakeningğ•„ : Weakening ğ•„
  wkâˆ£_â†‘_âˆ£_ {{Weakeningğ•„}} = wkğ•„âˆ£_â†‘_âˆ£_

  Weakeningğ•Šğ”¼ : Weakening ğ•Šğ”¼
  wkâˆ£_â†‘_âˆ£_ {{Weakeningğ•Šğ”¼}} = wkğ•Šğ”¼âˆ£_â†‘_âˆ£_

  Weakeningğ•Š : Weakening ğ•Š
  wkâˆ£_â†‘_âˆ£_ {{Weakeningğ•Š}} = wkğ•Šâˆ£_â†‘_âˆ£_

infixr 30 sğ•‚âˆ£ğ•Šğ”¼_/_âˆ£_
infixr 30 sğ•‹âˆ£ğ•Šğ”¼_/_âˆ£_
infixr 30 sğ•„âˆ£ğ•Šğ”¼_/_âˆ£_
infixr 30 sâ„‚âˆ£â„‚_/_âˆ£_

sğ•‚âˆ£ğ•Šğ”¼_/_âˆ£_ : ğ•Šğ”¼ â†’ â„• â†’ ğ•‚ â†’ ğ•‚
sğ•‚âˆ£ğ•Šğ”¼ s / x âˆ£ Tyâ‚— = Tyâ‚—

sğ•‹âˆ£ğ•Šğ”¼_/_âˆ£_ : ğ•Šğ”¼ â†’ â„• â†’ ğ•‹ â†’ ğ•‹
sğ•‹âˆ£ğ•Šğ”¼ s / x âˆ£ tvarâ‚— y
  with y â‰¥? x
...  | no  _             = tvarâ‚— y
...  | yes _
    with y â‰Ÿ x
...    | no  _           = tvarâ‚— (y âˆ¸ 1)
...    | yes _
      with s
...      | T /ğ•‹          = T
...      | _ /ğ•„          = âŠ¤â‚—
sğ•‹âˆ£ğ•Šğ”¼ s / x âˆ£ (U âŠ¸â‚— V)   = sğ•‹âˆ£ğ•Šğ”¼ s / x âˆ£ U âŠ¸â‚— sğ•‹âˆ£ğ•Šğ”¼ s / x âˆ£ V
sğ•‹âˆ£ğ•Šğ”¼ s / x âˆ£ (!â‚— U)     = !â‚— sğ•‹âˆ£ğ•Šğ”¼ s / x âˆ£ U
sğ•‹âˆ£ğ•Šğ”¼ s / x âˆ£ (âˆ€â‚— K âˆ™ U) = âˆ€â‚— sğ•‚âˆ£ğ•Šğ”¼ s / x âˆ£ K âˆ™ sğ•‹âˆ£ğ•Šğ”¼ wkâˆ£ 1 â†‘ 0 âˆ£ s / suc x âˆ£ U

sğ•„âˆ£ğ•Šğ”¼_/_âˆ£_ : ğ•Šğ”¼ â†’ â„• â†’ ğ•„ â†’ ğ•„
sğ•„âˆ£ğ•Šğ”¼ s / x âˆ£ varâ‚— y
  with y â‰¥? x
...  | no  _                      = varâ‚— y
...  | yes _
    with y â‰Ÿ x
...    | no  _                    = varâ‚— (y âˆ¸ 1)
...    | yes _
      with s
...      | M /ğ•„                   = M
...      | _ /ğ•‹                   = ttâ‚—
sğ•„âˆ£ğ•Šğ”¼ s / x âˆ£ (Î»â‚— T âˆ˜ N)          = Î»â‚— sğ•‹âˆ£ğ•Šğ”¼ s / x âˆ£ T âˆ˜ sğ•„âˆ£ğ•Šğ”¼ wkâˆ£ 1 â†‘ 0 âˆ£ s / suc x âˆ£ N
sğ•„âˆ£ğ•Šğ”¼ s / x âˆ£ (N $â‚—âˆ˜ O)           = sğ•„âˆ£ğ•Šğ”¼ s / x âˆ£ N $â‚—âˆ˜ sğ•„âˆ£ğ•Šğ”¼ s / x âˆ£ O
sğ•„âˆ£ğ•Šğ”¼ s / x âˆ£ bangâ‚— N             = bangâ‚— (sğ•„âˆ£ğ•Šğ”¼ s / x âˆ£ N)
sğ•„âˆ£ğ•Šğ”¼ s / x âˆ£ (let-bangâ‚— N inâ‚— O) = let-bangâ‚— sğ•„âˆ£ğ•Šğ”¼ s / x âˆ£ N inâ‚— sğ•„âˆ£ğ•Šğ”¼ wkâˆ£ 1 â†‘ 0 âˆ£ s / suc x âˆ£ O
sğ•„âˆ£ğ•Šğ”¼ s / x âˆ£ (Î›â‚— K âˆ™ N)          = Î›â‚— sğ•‚âˆ£ğ•Šğ”¼ s / x âˆ£ K âˆ™ sğ•„âˆ£ğ•Šğ”¼ wkâˆ£ 1 â†‘ 0 âˆ£ s / suc x âˆ£ N
sğ•„âˆ£ğ•Šğ”¼ s / x âˆ£ (N $$â‚—âˆ™ T)          = sğ•„âˆ£ğ•Šğ”¼ s / x âˆ£ N $$â‚—âˆ™ sğ•‹âˆ£ğ•Šğ”¼ s / x âˆ£ T

sğ•Šğ”¼âˆ£ğ•Šğ”¼_/_âˆ£_ : ğ•Šğ”¼ â†’ â„• â†’ ğ•Šğ”¼ â†’ ğ•Šğ”¼
sğ•Šğ”¼âˆ£ğ•Šğ”¼ s / x âˆ£ (T /ğ•‹) = sğ•‹âˆ£ğ•Šğ”¼ s / x âˆ£ T /ğ•‹
sğ•Šğ”¼âˆ£ğ•Šğ”¼ s / x âˆ£ (M /ğ•„) = sğ•„âˆ£ğ•Šğ”¼ s / x âˆ£ M /ğ•„

-- Do we really want this?
sâ„‚âˆ£â„‚_/_âˆ£_ : â„‚ â†’ â„• â†’ â„‚ â†’ â„‚
sâ„‚âˆ£â„‚ Î“ / x     âˆ£ []               = []
sâ„‚âˆ£â„‚ Î“ / zero  âˆ£ (K       /ğ•‚ âˆ· Î”) = Î“ ++ Î”
sâ„‚âˆ£â„‚ Î“ / suc x âˆ£ (K       /ğ•‚ âˆ· Î”) = sğ•‚âˆ£ğ•Šğ”¼ âŠ¤â‚— /ğ•‹ / x âˆ£ wkâˆ£ len Î“ â†‘ suc x âˆ£ K /ğ•‚ âˆ· sâ„‚âˆ£â„‚ Î“ / x âˆ£ Î”
sâ„‚âˆ£â„‚ Î“ / zero  âˆ£ ((T , u) /ğ•‹ âˆ· Î”) = Î“ â„‚Ã—ğ•Œ u ++ Î”
sâ„‚âˆ£â„‚ Î“ / suc x âˆ£ ((T , u) /ğ•‹ âˆ· Î”) = (sğ•‹âˆ£ğ•Šğ”¼ ttâ‚— /ğ•„ / x âˆ£ wkâˆ£ len Î“ â†‘ suc x âˆ£ T , u) /ğ•‹ âˆ· sâ„‚âˆ£â„‚ Î“ / x âˆ£ Î”

record Substitution (S : Set) (T : Set) : Set where
  inductive
  constructor mkSubstitution
  infixr 30 sâˆ£_/_âˆ£_
  field
    sâˆ£_/_âˆ£_ : T â†’ â„• â†’ S â†’ S

open Substitution {{...}} public

{-# DISPLAY Substitution.sâˆ£_/_âˆ£_ t m s = sâˆ£ t / m âˆ£ s #-}

instance
  Substitutionğ•‚ğ•Šğ”¼ : Substitution ğ•‚ ğ•Šğ”¼
  sâˆ£_/_âˆ£_ {{Substitutionğ•‚ğ•Šğ”¼}} = sğ•‚âˆ£ğ•Šğ”¼_/_âˆ£_

  Substitutionğ•‹ğ•Šğ”¼ : Substitution ğ•‹ ğ•Šğ”¼
  sâˆ£_/_âˆ£_ {{Substitutionğ•‹ğ•Šğ”¼}} = sğ•‹âˆ£ğ•Šğ”¼_/_âˆ£_

  Substitutionğ•„ğ•Šğ”¼ : Substitution ğ•„ ğ•Šğ”¼
  sâˆ£_/_âˆ£_ {{Substitutionğ•„ğ•Šğ”¼}} = sğ•„âˆ£ğ•Šğ”¼_/_âˆ£_

  Substitutionğ•Šğ”¼ğ•Šğ”¼ : Substitution ğ•Šğ”¼ ğ•Šğ”¼
  sâˆ£_/_âˆ£_ {{Substitutionğ•Šğ”¼ğ•Šğ”¼}} = sğ•Šğ”¼âˆ£ğ•Šğ”¼_/_âˆ£_

  Substitutionâ„‚â„‚ : Substitution â„‚ â„‚
  sâˆ£_/_âˆ£_ {{Substitutionâ„‚â„‚}} M = sâ„‚âˆ£â„‚ M /_âˆ£_

Î»â‚—_âˆ™_ : ğ•‹ â†’ ğ•„ â†’ ğ•„
Î»â‚— T âˆ™ M = Î»â‚— !â‚— T âˆ˜ let-bangâ‚— varâ‚— 0 inâ‚— wkâˆ£ 1 â†‘ 1 âˆ£ M
