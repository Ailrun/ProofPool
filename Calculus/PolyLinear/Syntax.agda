module Calculus.PolyLinear.Syntax where

open import Data.Empty
open import Data.List
open import Data.Nat
open import Data.Product
open import Data.Unit
open import Relation.Nullary

-- Kind
data ğ•‚ : Set where
  Tyâ‚— : ğ•‚

infixr 30 tvarâ‚—
infixr 30 !â‚—_
infixr 29 _âŠ¸â‚—_
infixr 28 âˆ€â‚—_âˆ™_

-- Type
data ğ•‹ : Set where
  tvarâ‚— : â„• â†’ ğ•‹
  _âŠ¸â‚—_  : ğ•‹ â†’ ğ•‹ â†’ ğ•‹
  !â‚—_   : ğ•‹ â†’ ğ•‹
  âˆ€â‚—_âˆ™_ : ğ•‚ â†’ ğ•‹ â†’ ğ•‹

infixr 30 varâ‚—
infixr 30 bangâ‚—
infixl 29 _$â‚—âˆ˜_
infixl 29 _$$â‚—âˆ™_
infixr 28 let-bangâ‚—_inâ‚—_
infixr 27 Î»â‚—_âˆ˜_
infixr 27 Î›â‚—_âˆ™_

-- Term
data ğ•„ : Set where
  varâ‚—           : â„• â†’ ğ•„
  Î»â‚—_âˆ˜_          : ğ•‹ â†’ ğ•„ â†’ ğ•„
  _$â‚—âˆ˜_          : ğ•„ â†’ ğ•„ â†’ ğ•„
  bangâ‚—          : ğ•„ â†’ ğ•„
  let-bangâ‚—_inâ‚—_ : ğ•„ â†’ ğ•„ â†’ ğ•„
  Î›â‚—_âˆ™_          : ğ•‚ â†’ ğ•„ â†’ ğ•„
  _$$â‚—âˆ™_         : ğ•„ â†’ ğ•‹ â†’ ğ•„

-- Usage
data ğ•Œ : Set where
  âˆâ‚—   : ğ•Œ
  0/1â‚— : ğ•Œ
  1/1â‚— : ğ•Œ

infixr 5 _ğ•‚âˆ·_
infixr 5 _ğ•‹âˆ·_

-- Context
data â„‚ : Set where
  []   : â„‚
  _ğ•‚âˆ·_ : ğ•‚ â†’ â„‚ â†’ â„‚
  _ğ•‹âˆ·_ : ğ•‹ Ã— ğ•Œ â†’ â„‚ â†’ â„‚

-- Context Skeleton
data â„‚â» : Set where
  []   : â„‚â»
  _ğ•‚âˆ·_ : ğ•‚ â†’ â„‚â» â†’ â„‚â»
  _ğ•‹âˆ·_ : ğ•‹ â†’ â„‚â» â†’ â„‚â»

variable
  x xâ€² xâ€³ xâ‚€ xâ‚ xâ‚‚ : â„•
  y yâ€² yâ€³ yâ‚€ yâ‚ yâ‚‚ : â„•
  z zâ€² zâ€³ zâ‚€ zâ‚ zâ‚‚ : â„•

  K Kâ€² Kâ€³ Kâ‚€ Kâ‚ Kâ‚‚ : ğ•‚

  T Tâ€² Tâ€³ Tâ‚€ Tâ‚ Tâ‚‚ : ğ•‹
  U Uâ€² Uâ€³ Uâ‚€ Uâ‚ Uâ‚‚ : ğ•‹
  V Vâ€² Vâ€³ Vâ‚€ Vâ‚ Vâ‚‚ : ğ•‹

  M Mâ€² Mâ€³ Mâ‚€ Mâ‚ Mâ‚‚ : ğ•„
  N Nâ€² Nâ€³ Nâ‚€ Nâ‚ Nâ‚‚ : ğ•„
  O Oâ€² Oâ€³ Oâ‚€ Oâ‚ Oâ‚‚ : ğ•„
  P Pâ€² Pâ€³ Pâ‚€ Pâ‚ Pâ‚‚ : ğ•„

  u uâ€² uâ€³ uâ‚€ uâ‚ uâ‚‚ : ğ•Œ

  Î“ Î“â€² Î“â€³ Î“â‚€ Î“â‚ Î“â‚‚ : â„‚
  Î” Î”â€² Î”â€³ Î”â‚€ Î”â‚ Î”â‚‚ : â„‚
  Î¨ Î¨â€² Î¨â€³ Î¨â‚€ Î¨â‚ Î¨â‚‚ : â„‚

  Î“â» Î“â»â€² Î“â»â€³ Î“â»â‚€ Î“â»â‚ Î“â»â‚‚ : â„‚â»
  Î”â» Î”â»â€² Î”â»â€³ Î”â»â‚€ Î”â»â‚ Î”â»â‚‚ : â„‚â»
  Î¨â» Î¨â»â€² Î¨â»â€³ Î¨â»â‚€ Î¨â»â‚ Î¨â»â‚‚ : â„‚â»

infixr 30 wkâ„•âˆ£â„•_/â†‘_âˆ£_
infixr 30 wkğ•‹âˆ£ğ•‹_/â†‘_âˆ£_
infixr 30 wkğ•„âˆ£ğ•‹_/â†‘_âˆ£_
infixr 30 wkğ•„âˆ£ğ•„_/â†‘_âˆ£_

wkâ„•âˆ£â„•_/â†‘_âˆ£_ : â„• â†’ â„• â†’ â„• â†’ â„•
wkâ„•âˆ£â„• n /â†‘ m âˆ£ x
  with x â‰¥? m
...  | no  _ = x
...  | yes _ = n + x

wkğ•‹âˆ£ğ•‹_/â†‘_âˆ£_ : â„• â†’ â„• â†’ ğ•‹ â†’ ğ•‹
wkğ•‹âˆ£ğ•‹ n /â†‘ m âˆ£ tvarâ‚— x    = tvarâ‚— (wkâ„•âˆ£â„• n /â†‘ m âˆ£ x)
wkğ•‹âˆ£ğ•‹ n /â†‘ m âˆ£ (T âŠ¸â‚— U)   = wkğ•‹âˆ£ğ•‹ n /â†‘ m âˆ£ T âŠ¸â‚— wkğ•‹âˆ£ğ•‹ n /â†‘ m âˆ£ U
wkğ•‹âˆ£ğ•‹ n /â†‘ m âˆ£ (!â‚— T)     = !â‚— (wkğ•‹âˆ£ğ•‹ n /â†‘ m âˆ£ T)
wkğ•‹âˆ£ğ•‹ n /â†‘ m âˆ£ (âˆ€â‚— K âˆ™ T) = âˆ€â‚— K âˆ™ wkğ•‹âˆ£ğ•‹ n /â†‘ suc m âˆ£ T

wkğ•„âˆ£ğ•‹_/â†‘_âˆ£_ : â„• â†’ â„• â†’ ğ•„ â†’ ğ•„
wkğ•„âˆ£ğ•‹ n /â†‘ m âˆ£ varâ‚— x              = varâ‚— x
wkğ•„âˆ£ğ•‹ n /â†‘ m âˆ£ (Î»â‚— T âˆ˜ M)          = Î»â‚— wkğ•‹âˆ£ğ•‹ n /â†‘ m âˆ£ T âˆ˜ wkğ•„âˆ£ğ•‹ n /â†‘ m âˆ£ M
wkğ•„âˆ£ğ•‹ n /â†‘ m âˆ£ (M $â‚—âˆ˜ N)           = wkğ•„âˆ£ğ•‹ n /â†‘ m âˆ£ M $â‚—âˆ˜ wkğ•„âˆ£ğ•‹ n /â†‘ m âˆ£ N
wkğ•„âˆ£ğ•‹ n /â†‘ m âˆ£ bangâ‚— M             = bangâ‚— (wkğ•„âˆ£ğ•‹ n /â†‘ m âˆ£ M)
wkğ•„âˆ£ğ•‹ n /â†‘ m âˆ£ (let-bangâ‚— M inâ‚— N) = let-bangâ‚— wkğ•„âˆ£ğ•‹ n /â†‘ m âˆ£ M inâ‚— wkğ•„âˆ£ğ•‹ n /â†‘ m âˆ£ N
wkğ•„âˆ£ğ•‹ n /â†‘ m âˆ£ (Î›â‚— K âˆ™ M)          = Î›â‚— K âˆ™ wkğ•„âˆ£ğ•‹ n /â†‘ suc m âˆ£ M
wkğ•„âˆ£ğ•‹ n /â†‘ m âˆ£ (M $$â‚—âˆ™ T)          = wkğ•„âˆ£ğ•‹ n /â†‘ m âˆ£ M $$â‚—âˆ™ wkğ•‹âˆ£ğ•‹ n /â†‘ m âˆ£ T

wkğ•„âˆ£ğ•„_/â†‘_âˆ£_ : â„• â†’ â„• â†’ ğ•„ â†’ ğ•„
wkğ•„âˆ£ğ•„ n /â†‘ m âˆ£ varâ‚— x              = varâ‚— (wkâ„•âˆ£â„• n /â†‘ m âˆ£ x)
wkğ•„âˆ£ğ•„ n /â†‘ m âˆ£ (Î»â‚— T âˆ˜ M)          = Î»â‚— T âˆ˜ wkğ•„âˆ£ğ•„ n /â†‘ suc m âˆ£ M
wkğ•„âˆ£ğ•„ n /â†‘ m âˆ£ (M $â‚—âˆ˜ N)           = wkğ•„âˆ£ğ•„ n /â†‘ m âˆ£ M $â‚—âˆ˜ wkğ•„âˆ£ğ•„ n /â†‘ m âˆ£ N
wkğ•„âˆ£ğ•„ n /â†‘ m âˆ£ bangâ‚— M             = bangâ‚— (wkğ•„âˆ£ğ•„ n /â†‘ m âˆ£ M)
wkğ•„âˆ£ğ•„ n /â†‘ m âˆ£ (let-bangâ‚— M inâ‚— N) = let-bangâ‚— wkğ•„âˆ£ğ•„ n /â†‘ m âˆ£ M inâ‚— wkğ•„âˆ£ğ•„ n /â†‘ suc m âˆ£ N
wkğ•„âˆ£ğ•„ n /â†‘ m âˆ£ (Î›â‚— K âˆ™ M)          = Î›â‚— K âˆ™ wkğ•„âˆ£ğ•„ n /â†‘ m âˆ£ M
wkğ•„âˆ£ğ•„ n /â†‘ m âˆ£ (M $$â‚—âˆ™ T)          = wkğ•„âˆ£ğ•„ n /â†‘ m âˆ£ M $$â‚—âˆ™ T

Î»â‚—_âˆ™_ : ğ•‹ â†’ ğ•„ â†’ ğ•„
Î»â‚— T âˆ™ M = Î»â‚— !â‚— T âˆ˜ let-bangâ‚— varâ‚— 0 inâ‚— wkğ•„âˆ£ğ•„ 1 /â†‘ 1 âˆ£ M

useableğ•Œ : ğ•Œ â†’ Set
useableğ•Œ âˆâ‚—   = âŠ¤
useableğ•Œ 0/1â‚— = âŠ¤
useableğ•Œ 1/1â‚— = âŠ¥

incğ•Œ : (u : ğ•Œ) â†’ .(useableğ•Œ u) â†’ ğ•Œ
incğ•Œ âˆâ‚—   _ = âˆâ‚—
incğ•Œ 0/1â‚— _ = 1/1â‚—

extractâ„‚â» : â„‚ â†’ â„‚â»
extractâ„‚â» []             = []
extractâ„‚â» (K       ğ•‚âˆ· Î“) = K ğ•‚âˆ· extractâ„‚â» Î“
extractâ„‚â» ((T , _) ğ•‹âˆ· Î“) = T ğ•‹âˆ· extractâ„‚â» Î“
